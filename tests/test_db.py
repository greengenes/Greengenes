#!/usr/bin/env python

from greengenes.db import GreengenesMySQL
from cogent.util.unit_test import TestCase,main

__author__ = "Daniel McDonald"
__copyright__ = "Copyright 2013, Greengenes"
__credits__ = ["Daniel McDonald"]
__license__ = "GPL"
__version__ = "0.1-dev"
__maintainer__ = "Daniel McDonald"
__email__ = "mcdonadt@colorado.edu"
__status__ = "Development"

class GGMySQLTests(TestCase):
    def setUp(self):
        self.db = GreengenesMySQL(debug=True)

    def tearDown(self):
        del self.db

    def test_getPyNASTSequenceGGID(self):
        """Get a single PyNAST sequence by GG_ID"""
        exp = gg_id_86_pynast_seq
        obs = self.db.getPyNASTSequenceGGID(86)
        self.assertEqual(obs,exp)

    def test_getSSUAlignSequenceGGID(self):
        """Get a single SSU Align sequence by GG_ID"""
        exp = gg_id_4_ssualigned_seq
        obs = self.db.getSSUAlignSequenceGGID(4)
        self.assertEqual(obs, exp)

    def test_getUnalignedSequenceGGID(self):
        # insert, then pull out
        self.fail()


    def test_get_sequence_ggid(self):
        """Implicitly tested by other sequence obtaining methods"""
        pass

    def test_get_max_seqid(self):
        """get the max seq id"""
        # as of gg_13_5... 
        self.assertEqual(self.db._get_max_seqid(), 2796094)

    def test_locking(self):
        """Lock some tables"""
        self.assertRaises(ValueError, self.db._lock, [['a','b','c']])
        self.assertEqual(self.db._have_locks, False)
        
        self.db._lock([['greengenes','g','read']])
        self.assertTrue(self.db._have_locks)
        self.assertEqual(self.db._lock_aliases, {'greengenes':'g'})
        
        self.db._unlock()
        self.assertFalse(self.db._have_locks)
        self.assertEqual(self.db._lock_aliases, {})

    def test_updatePyNASTSequences(self):
        """Update the seqs"""
        self.db.cursor.execute('select gg_id from greengenes where pynast_aligned_seq_id is null')
        ggids = [str(i[0]) for i in self.db.cursor.fetchall()]
        self.assertGreaterThan(len(ggids), 0)

        seqs = dict([(i,'ATGC_%s' % i) for i in ggids])
        self.db.updatePyNASTSequences(seqs)

        exp = seqs
        obs_cur = self.db.cursor.execute("""select g.gg_id, s.sequence 
                                from greengenes g inner join sequence s
                                    on g.pynast_aligned_seq_id=s.seq_id
                                where g.gg_id in (%s)""" % ','.join(exp.keys()))
        obs = dict([(str(id_), seq) for id_, seq in self.db.cursor.fetchall()])
        self.assertEqual(obs,exp)

    def test_updateSSUAlignSequences(self):
        """Update the seqs"""
        self.db.cursor.execute('select gg_id from greengenes where aligned_seq_id is null')
        ggids = [str(i[0]) for i in self.db.cursor.fetchall()]
        self.assertGreaterThan(len(ggids), 0)

        seqs = dict([(i,'ATGC_%s' % i) for i in ggids])
        self.db.updateSSUAlignSequences(seqs)

        exp = seqs
        obs_cur = self.db.cursor.execute("""select g.gg_id, s.sequence 
                                from greengenes g inner join sequence s
                                    on g.aligned_seq_id=s.seq_id
                                where g.gg_id in (%s)""" % ','.join(exp.keys()))
        obs = dict([(str(id_), seq) for id_, seq in self.db.cursor.fetchall()])
        self.assertEqual(obs,exp)

    def test_updateUnlignedSequences(self):
        """Update the seqs"""
        self.db.cursor.execute('select gg_id from greengenes where unaligned_seq_id is null')
        ggids = [str(i[0]) for i in self.db.cursor.fetchall()]
        self.assertGreaterThan(len(ggids), 0)

        seqs = dict([(i,'ATGC_%s' % i) for i in ggids])
        self.db.updateUnalignedSequences(seqs)

        exp = seqs
        obs_cur = self.db.cursor.execute("""select g.gg_id, s.sequence 
                                from greengenes g inner join sequence s
                                    on g.unaligned_seq_id=s.seq_id
                                where g.gg_id in (%s)""" % ','.join(exp.keys()))
        obs = dict([(str(id_), seq) for id_, seq in self.db.cursor.fetchall()])
        self.assertEqual(obs,exp)

    def test_update_seq_field(self):
        """tested implicitly by other sequence field update methods"""
        pass

gg_id_86_pynast_seq = "-----------------------------------------------------------------------------------------------------------------------------------------GC-T-AC-T-GC--TAT-T--G-GG-ATTC--GA---T-T--AAGCCA-T-NC-A-AGT-TGA-A-CGA---------A-T------------------------------------------------------------------------------------------------TTA-GA---------------------------------------------------------------------------------------------------------------------TT--CG-T-GG-C-GT-A--C-------------GGC-TCAGT-A--AC-AC-G-T-G-GA---TAA--C-CT-A--C-C-CTT--AG-G------------------------------------------------------------------A-CT----GGG-AT-AA-CTC-------------------------T-G-G-----------------------GAA-A---CTG-GGG-ATAA-TA---CC-G--G-AT-A---------------------------------G--G-C-A--A--T-----------------TT-TTCC-T-----------------------------------------------------------------------------------------------------------------------G-TA-A--------------------------------------------------------------------------------------------------------------------------------------T-G-GT-T-T---------------T--T-T-G-T-T-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------TAAATGTTTT---------------------------------------------------------------------------------------------------------------------------------------TTT-T----------------------------------------------------------------------------------------------------------------------------------C-----G--------------C----C-T---A-AG-G---AT---G-G-----G-TCT-GCG--G-CAG--A------TT--A--G-GT-A----G---TTGG-T-T-AG-G-T----AAT-GG-C-T-T-ACCA--A-GC-C-G--T-TG-A------------TCT-G-T------AC-GG-G-T-TGT-G-AG----A--GC-AA--G-AG-C-CC-GGAG-A-TGGAA--C-C-TG-A-GA-C-AA-G-G-TTCCAG-GCCC-TAC-G--G-G-G-C-GC-A-GC-A-G-GC---GC-G-A-AAC-CTCCG-C-AA-T-GT--GA-GA-A----A-T-CG-C-GA-CG-GG-GGGA-TCCC-A-AG-T---G-C-C--A--T----------T-C-T--------TA-AC-------------G-G-G--------A--T-GGC--------TT-TT-C-A--T-TAG----T------------------------------G--T--AA-A---G----A------------------------------G-C-TT-T-TG-G---------AA-----------TAAGA-GCTGGG-C--AA---G-AC-CGTT--GCCA--A-C---C--GCCG---C-GG--TA-AC--AC---CG-TC-AGC-TCT-A-G-TG-GTAG-C-AGT-TT-TT-A--T-T--GGGC-CTA----AA-GCGT-CC--G-TA-G-C-C-G------------G--T-TT-A-T-T-AA----G-T-C-T---C-TGG-TG-A-AA-TC--CT-GTA-G--------------------------------------------------------------------CT-T-AA-------------------------------------------------------------------------CT-G-T-GG-GA-AT---T-G-C-T-G-G--------A--GA-T-A-C-T-A-GTA--G-A-C---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------T-T-G-A-G-A-T-----C-GG--GA-G-A------------G-GT-T-AG-A----GG--TACT-CCC-A-GG--GT-A-GAG-GTGAAA-TT-CTG-TAAT-C-CT-G-GGA--GG-A-CC-G-CC-TG--T--G--GC-GAA-G--G-C---G----T--C-T-AGCTG------G-AA-C---------------------------------------------------------------GATT-C-T--GC--CG-----GT-GA-GG--G-A-CGA--AA-G-C--------------T-AGGG-GCG-C-G-AACC--GG-ATTA-G-ATA-C-----CC-G-G-GTA-G-T----C-CT--A-G-CTG-T-AAA--C-GATG-CG--GA-CT---------T-GG--T--G-T-TG-G-GA-T--G--GC----------------------------------------------------------------------------------TTT-GA---------------------------------------------------------------------------------------------------------------------------------------------GC---T-G-C-TC--C-A-G-T-GC-C------GA--A----GG-GAA--GC-T-G-T--T--AA-GT--C----C-GCC-GCC-T-G-GG-AAG-TA---CGG-----T-C--G-C-A-A-GAC-T--GAA-ACTT-AAA---------GGAA-TTG-GCGGG-G-G-AGCA----CCA--C-A-A-CGC-GT-G--G--AG-CC-T--GC-GGT-TT-AATT-G-G-ATT-CAAC-G-CC-G-GA-C-A-TC-TC-A-CC-AGAGG-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------CGACAGC--TGTATGATGACCAGTTTGATGAGCTTGTT-TGA-CTAGCTGAG-A-G-G-A-GGTG-CA-TGG-CC--GCC-GTC-A-GC-TC---G-TA-CC-G--TGA-GG-CGT-C-CT-G-TT-AA-GT-CAGGC-AA--------C-GAG-CGA-G-ACC-C-A-CG--CC--C-TTAG--T-T-A-C-C---AG-C-G--G--AT-TC----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------TAG-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------TGA---A---TG---C----C-G------------G----G---C-A--CA---------------C-T-A-G-G-GG-G--AC-C-G-CCT--G-T------------------------------------G-A---TAA----------------------------------A-T-A-G--G-A-GG-A--AGG-A--GTGG-A-CGAC-GGT--AGGT-C---CGT-A-T-G-C-C-C-CGA----AT-C--CT-C-T-GG-GC-AA-CAC-GCGGG-C--TA--CAATG---G-ATGA-G-A--C-AAT-GG-GT--------------------------------------------------------------------------------------------------T-C-C-G-A--C-GCCG-A--A---------------------------------------A-GG-T-G-----------G--A-G-GT---A----------A--TCC-T------C-T-AAACT-TA-T-T-C-G-TAG-TTC--------GGA-T-TGAGG-AC--T-GTAA-CT-C-------------------------------------------------------------------------------------------------G-TTCTC-A-T-G-AA-G-CT-GGAAT-GC-G-TA--G-TA-AT-C-G-C----GTG-TC-A-T--A------AT--CGC-GC-G-GT-G-AAT-ACGT-C-CCTGCTCCT-TGGA----CACACCG-CCC-GTC-----A---CG---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------"

gg_id_4_ssualigned_seq = "-----------------------------------------------------------------------------------------------------------------------------------------------C-T-GC--TAT-T--G-GG-ATCC--GA---C-T--AAGCCA-T-GC-A-AGC-CCA------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------GG-C-AG-A--A-------------GGC-TCAGT-A--AC-AC-G-T-C-GC---TAA--C-CT-G--C-C-CTA--AG-G------------------------------------------------------------------T-CC----AGG-AT-AA-CCT-------------------------C-G-G-----------------------GAA-A---CTG-AGG-ATAA-TA---CT-G--G-AT-G---------------------------------G--G-G-A--A--A-----------------AG-ATAC-T-----------------------------------------------------------------------------------------------------------------------G-GA-A--------------------------------------------------------------------------------------------------------------------------------------T-G-TT-C-T---------------C--T-T-C-C-T-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------TAAA------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------G--------------C----C-T---T-AG-G---AT---G-G-----G-GCG-GCG--G-CCG--A------TT--A--G-GT-T----G---TTGG-C-G-GT-G-T----AAT-GG-A-C-C-ACCA--A-GC-C-T--A-TG-A------------TCG-G-T------AC-GG-G-C-CAT-G-AG----A--GT-GG--T-AG-C-CC-GGAG-A-AGGGT--A-C-TG-A-GA-T-AC-G-G-ACCCTA-GCCC-TAC-G--G-G-G-T-GC-A-GC-A-G-GC---GC-G-A-AAC-CTCTG-C-AA-T-GC--AC-GA-A----A-G-TG-T-GA-CA-GG-GGGA-TCCC-A-AG-T---G-----------------------------------------------------------------------C--------TT-TT-G-T--C-AAG----G------------------------------G--T--AA-G---T----A------------------------------C-C-TT-G-AC-----------AA-----------TAAGC-GGTGGG-T--AA---G--C-TGGT--GCCA--G-C---C--GCCG---C-GG--TA-AC--AC---CA-GC-GCC-GCA-A-G-TG-GGGA-C-CGC-TA-TT-A--T-T--GGGC-CTA----AA-GCAT-CC--G-TA-G-C-C-G------------G--T-CA-A-A-T-AA----A-T-C-T---T-CTG-TG-A-AA-TC--GT-TCA-G--------------------------------------------------------------------CT-T-AA-------------------------------------------------------------------------CT-G-A-AC-GG------T-G-C-A-G-A--------A--GA-C-A-C-T-G-TTT--G-G-C---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------T-A-G-G-G-A-C-----C-GG--GA-G-G------------C-GT-A-AG-A----GG--TATT-CGT-A-GG--GT-A-GCG-GTAAAA-TG-CGA-TAAT-C-CT-A-CGA--AG-A-CC-A-CC-TG--T--G--GC-GAA-G--G-C---G----T--C-T-TACGA------G-AA-C---------------------------------------------------------------GGCT-C-C--GA--CG-----GT-GA-GG--G-A-TGA--AG-G-C--------------C-AGGG-GAG-C-G-AATG--GG-ATTA-G-ATA-C-----CC-C-A-GTA-G-T----C-CT--G-G-CAG-T-AAA--C-CCTG-CG--AG-CT---------A-GG--T--G-T-CG-C-GC-A--T--CC----------------------------------------------------------------------------------TCC------------------------------------------------------------------------------------------------------------------------------------------------GG---G-T-G-TG--C-G-G-T-GT-C------GT--A----GA-GAA--GT-C-G-T--T--AA-GC--T----C-GCC-GCC-T-G-GG-AAG-TA---CGG-----T-C--G-C-A-A-GGC-T--GAA-ACTT-AAA---------GGAA-TTG-GCGGG-G-G-AGCA----CTA--C-A-A-GGG-GT-G--C--GG-CG-T--GC-GGT-TT-AATT-G-G-ATT-CAAC-G-CC-G-AA-A-A-TC-TC-A-CC-AGGGG-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------AGACGGC--AGAATGAAGGTCAGTCTAAAGGGCTTACC-TGA-CGAGCCGAG-A-G-G-T-GGTG-CA-TGG-CC--GTC-GTC-A-GC-TC---G-TG-CC-G--TGA-GG-TGT-C-CT-G-TT-AA-GT-CAGGC-AA--------C-GAG-CGA-G-ACC-T-G-TG--CC--T-ACAC--T-T-G-C-C---A-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------T---------------G-T-G-T-A-GG-G--AC-T-G-CCT--G-G------------------------------------G-----AAA----------------------------------C-C-A-G--G-A-GG-A--AGG-T--ACAG-G-CAAC-GGT--AGGT-C---TGT-A-T-G-C-C-C-CGA----AT-C--CA-C-T-GG-GC-TA-CAC-GCGCG-C--AA--CAATG---G-ACGA-G-A--C-AAT-G--GC--------------------------------------------------------------------------------------------------T-G-C-A-A--C-ACCG-A--A---------------------------------------A-GG-T-G-----------A--A-G-CT---A----------A--TC-------------AAACT-CG-T-C-C-T-CAG-TAC--------GGA-T-TGAGG-CT--T-GTAA-CT-C-------------------------------------------------------------------------------------------------A-GCCTC-A-T-G-AC-G-CC-GGAAT-CC-C-TA--G-TA-AT-C-G-G----AGT-TC-A-T-C-------AT--ACT-CC-G-GT-G-AAC-ATGT-C-CCTGTTCCT-TGTT----CACACCG-CCC-GTC-----A---AA--CCA-CT-CG-A--G---CAG-G-GT-CT-GGA--T-GA-------G--G--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------T--CG--AAT-C----C-AGG-CT-CAG------------------------TG--AG------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------"
if __name__ == '__main__':
    main()

